<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calnect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <link href="style.css" rel="stylesheet">
  <script src="scripts.js"></script>
  <script src="./FileSaver.js/src/FileSaver.js"></script>
</head>

<body>
  <!-- added a holder for the navbar so we don't have to copy all of the code for every page -->
  <div id="nav-holder"></div>
  <script src="//code.jquery.com/jquery.min.js"></script>
  <script>
    $.get("navbar.html", function (data) {
      $("#nav-holder").replaceWith(data);
    });
  </script>


  <!-- Modal code from w3Schools -->
  <h2 id="test">MyCal</h2>

  <!-- Trigger/Open The Modal -->
  <button id="myBtn">Create Event</button>

  <!-- The Modal -->
  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <span class="close">&times;</span>
      <form name="create-event">
        <label for="event-name">Event name:</label>
        <input type="text" id="event-name" name="event-name" required placeholder="Enter Name"
          oninvalid="this.setCustomValidity('Please enter a name for the event')" oninput="this.setCustomValidity('')">
        <label for="start-time">Start time:</label>
        <select name="start-time" id="start-time"></select>
        <label for="end-time">End time:</label>
        <select name="end-time" id="end-time"></select>
        <script>
          // Create the hours options for select
          for (let i = 0; i < 24; i++) {
            let timeSelect = document.createElement("option");
            timeSelect.value = i;
            timeSelect.text =
              (i < 12) ? (((i % 12 == 0) ? 12 : i) + "am") :
                (((i % 12 == 0) ? 12 : i % 12) + "pm");
            let timeSelect2 = timeSelect.cloneNode(true);
            document.getElementById("start-time").add(timeSelect.cloneNode(true));
            document.getElementById("end-time").add(timeSelect);
          }
        </script>
        <!-- <label for="start-time">Start time:</label>
        <input type="time" id="start-time" name="start-time" value="12:00">
        <label for="end-time">End time:</label>
        <input type="time" id="end-time" name="end-time" value="13:00"> -->
        <label for="school-check">School:</label>
        <input type="checkbox" id="school-check" name="school-check" value="true">
        <input type="submit" id="submit-button" name="submit-button" value="Create Event">
      </form>
    </div>

  </div>

  <h2 class="text-center"><b>What are you accomplishing today?</b></h2>

  <div id="container"></div>

  <script>
    createCalendar(0, 23);

    var localKeys = [];
    var activeKeys = [];
    // console.log("localStorage keys: " + localKeys[0]);
    refreshCalendar();

    function createCalendar(start = 8, end = 20) {
      // console.log("HERE");
      const container = document.createElement("section");
      container.className = "container";

      // builds the calendar graphic
      for (var i = start; i <= end; i++) {
        const row = document.createElement("div");
        row.className = "row";
        row.id = i;
        container.appendChild(row);

        const time = document.createElement("div");
        time.className = "row";
        // Converts 24hr time to 12hr time
        const text = document.createTextNode(
          (i < 12) ? (((i % 12 == 0) ? 12 : i) + "am") :
                (((i % 12 == 0) ? 12 : i % 12) + "pm"));
        time.className = "col-2";

        time.appendChild(text);
        row.appendChild(time);
      }
      document.getElementById("container").appendChild(container);
    }

    // Adds an event to the DOM
    function addEvent(eventObj) {
      const newEvent = document.createElement("div");
      newEvent.className = "col-2";
      // TODO, check if there's a way to make the name of the form a variable
      const eventName = document.createTextNode(eventObj["event-name"]);
      newEvent.appendChild(eventName);
      newEvent.id = eventObj["key"];
      // TODO, set up multi hour events
      document.getElementById(eventObj["start-time"]).appendChild(newEvent);
    }

    function removeEvent(eventObj){
      const oldEvent = document.getElementById(eventObj["key"]);
      document.getElementById(eventObj["start-time"]).removeChild(oldEvent);
    }

    // a seperator for the name and time of an event for the event key
    var seperator = "@$";
    // Generates a key for the event based on the name, start time, and end time. 
    // Ex. Event name: jeff, start time: 3, end time 15. Output is jeff@$3@$15
    // This should prevent duplicates as no event needs to have the same name, start, and end.
    function generateEventKey(eventObj){
      return eventObj["start-time"] + seperator + eventObj["end-time"] + seperator + eventObj["event-name"] + seperator;
    }

    // refreshes the calendar based on what is in local storage
    function refreshCalendar() {
      localKeys = Object.keys(localStorage);
      for(const current of localKeys){
        if(!activeKeys.includes(current)){
          // console.log(JSON.parse(localStorage.getItem(current)));
          addEvent(JSON.parse(localStorage.getItem(current)));
          activeKeys.push(current);
        }
      }
      // console.log(localKeys);
      // console.log(activeKeys);
    }

    let jeffEvent = {
      "start-time": 12,
      "event-name": "jeff"
    }

    // document.getElementById(jeffEvent["start-time"]).appendChild(addEvent(jeffEvent));
    // document.getElementById("12").appendChild(addEvent(12, 1, "jeff2"));

    // const fs = require("fs");
    // console.log(v)

    // TODO Known bug: When the form validation doesn't pass (eg start time 
    // is after end time), you need to refresh the page to try again.
    // Also, you can only submit one entry per refresh
    // TODO (also) prevent user from putting @$ in the name
    const endTime = document.getElementById("end-time");
    const form = document.querySelector('form');
    // const jsonOut;
    form.addEventListener('submit', function submit() {
      // console.log("here");
      event.preventDefault();

      const data = new FormData(event.target);
      const value = Object.fromEntries(data.entries());
      value.key = generateEventKey(value);

      console.log({ value });
      console.log("Valid Time: " + validTime(value["start-time"], value["end-time"]));

      if (!validTime(value["start-time"], value["end-time"])) {
        endTime.setCustomValidity("End time must be after start time");
        endTime.reportValidity();
      } else {
        endTime.setCustomValidity("");
        modal.style.display = "none";

        let jsonOut = JSON.stringify(value);
        // console.log(jsonOut);
        // console.log(JSON.parse(jsonOut));
        var currLocal = localStorage.getItem("eventdata");

        // console.log(currLocal);
        if (!currLocal) currLocal = "";
        // console.log(currLocal);

        // Adds the new data while maintaining the old data
        localStorage.setItem(value["key"], jsonOut);
        // console.log(JSON.parse(localStorage.getItem(value["key"])));

        refreshCalendar();
      }
      // const blob = new Blob([jsonOut], {type: "application/json"});
      // saveAs(blob, "testfile.txt");
    });

    // localStorage.getItem("evenData.json", );

    // Get the modal
    var modal = document.getElementById("myModal");

    // Get the button that opens the modal
    var btn = document.getElementById("myBtn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the button, open the modal 
    btn.onclick = function () {
      modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
      modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

  </script>

</body>